name: Build sfd_tool

on:
  workflow_dispatch:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build:
    runs-on: windows-latest
    strategy:
      matrix:
        arch: [x64, x86]
        config: [Release]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup MSVS
        uses: TheMrMilchmann/setup-msvc-dev@v3
        with:
          arch: ${{ matrix.arch }}

      - name: Install GTK3 Runtime
        run: |
          # 根据架构选择对应的 GTK3 运行时
          if ("${{ matrix.arch }}" -eq "x64") {
            $gtkUrl = "https://github.com/tschoonj/GTK-for-Windows-Runtime-Environment-Installer/releases/download/2023-01-10/gtk3-runtime-3.24.34-2023-01-10-ts-win64.exe"
            $installPath = "C:\Program Files\gtk3"
          } else {
            $gtkUrl = "https://github.com/tschoonj/GTK-for-Windows-Runtime-Environment-Installer/releases/download/2023-01-10/gtk3-runtime-3.24.34-2023-01-10-ts-win32.exe"
            $installPath = "C:\Program Files (x86)\gtk3"
          }
          
          Invoke-WebRequest -Uri $gtkUrl -OutFile gtk3-runtime.exe
          Start-Process -Wait -FilePath .\gtk3-runtime.exe -ArgumentList "/S /D=$installPath"
          
          # 将 GTK3 bin 目录添加到 PATH
          echo "$installPath\bin" | Out-File -FilePath $env:GITHUB_PATH -Append

      - name: Create Build Directory
        run: New-Item -ItemType Directory -Force -Path ./build/${{ matrix.arch }}/${{ matrix.config }}/

      - name: Build sfd_tool (${{ matrix.arch }} - ${{ matrix.config }})
        run: |
          # 设置平台变量
          $platform = if ("${{ matrix.arch }}" -eq "x64") { "x64" } else { "Win32" }
          
          # 构建项目
          msbuild sfd_tool.vcxproj `
            /p:Configuration=${{ matrix.config }} `
            /p:Platform=$platform `
            /p:OutDir=./build/${{ matrix.arch }}/${{ matrix.config }}/ `
            /p:WindowsTargetPlatformVersion=10.0 `
            /p:PlatformToolset=v143 `
            /verbosity:minimal

      - name: Copy GTK3 Runtime DLLs
        run: |
          $sourceDir = if ("${{ matrix.arch }}" -eq "x64") { "C:\Program Files\gtk3\bin" } else { "C:\Program Files (x86)\gtk3\bin" }
          $destDir = "./build/${{ matrix.arch }}/${{ matrix.config }}/"
          
          # 复制必要的 GTK3 DLL 文件
          $gtkDlls = @(
            "libgtk-3-0.dll",
            "libgdk-3-0.dll",
            "libglib-2.0-0.dll",
            "libgobject-2.0-0.dll",
            "libgmodule-2.0-0.dll",
            "libgthread-2.0-0.dll",
            "libgio-2.0-0.dll",
            "libcairo-2.dll",
            "libcairo-gobject-2.dll",
            "libpango-1.0-0.dll",
            "libpangocairo-1.0-0.dll",
            "libpangoft2-1.0-0.dll",
            "libpangowin32-1.0-0.dll",
            "libgdk_pixbuf-2.0-0.dll",
            "libepoxy-0.dll",
            "libintl-8.dll",
            "libfontconfig-1.dll",
            "libfreetype-6.dll",
            "libharfbuzz-0.dll"
          )
          
          foreach ($dll in $gtkDlls) {
            if (Test-Path "$sourceDir\$dll") {
              Copy-Item "$sourceDir\$dll" -Destination $destDir -Force
            }
          }

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sfd_tool_${{ matrix.arch }}_${{ matrix.config }}
          path: ./build/${{ matrix.arch }}/${{ matrix.config }}/

  release:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: build
    steps:
      - name: Set Release Timestamp
        run: echo "RELEASE_TAG=sfd_tool_master_$(TZ='Asia/Shanghai' date +'%Y%m%d_%H%M')" >> $GITHUB_ENV

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: master

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: output
          pattern: sfd_tool_*_Release

      - name: Misc
        run: |
          cp master/*.md output/
          cp master/Lib/Channel9.dll output/sfd_tool_x86_Release/
          cp master/Lib/Channel.ini output/sfd_tool_x86_Release/
          cp master/Lib/libusb-1.0.dll output/sfd_tool_x64_Release/
          cd output
          mv sfd_tool_x86_Release sfd_tool_SPRD_Release
          mv sfd_tool_x64_Release sfd_tool_LibUSB_Release
          zip -r -v ../${{ env.RELEASE_TAG }}.zip .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          target_commitish: ${{ github.sha }}
          name: ${{ env.RELEASE_TAG }}
          draft: false
          prerelease: false
          body: |
            x86 ver work with SPRD driver, x64 ver work with libusb driver
            GTK3-based GUI application
          files: |
            ${{ env.RELEASE_TAG }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}