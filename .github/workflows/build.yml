name: Build sfd_tool

on:
  workflow_dispatch:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 30
    strategy:
      matrix:
        arch: [x64, x86]
        config: [Release]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup MSVS
        uses: TheMrMilchmann/setup-msvc-dev@v3
        with:
          arch: ${{ matrix.arch }}

      - name: Install MSYS2 and GTK3
        run: |
          # GitHub Actions Windows 镜像已预装 MSYS2
          $msysPath = "C:\msys64"
          
          Write-Host "安装 GTK3 开发包..."
          
          # 更新 MSYS2
          & "$msysPath\usr\bin\bash.exe" -lc "pacman -Syu --noconfirm"
          
          # 根据架构安装对应的 GTK3
          if ("${{ matrix.arch }}" -eq "x64") {
            Write-Host "安装 x64 GTK3 完整开发包..."
            & "$msysPath\usr\bin\bash.exe" -lc "pacman -S --noconfirm mingw-w64-x86_64-gtk3 mingw-w64-x86_64-harfbuzz mingw-w64-x86_64-pango mingw-w64-x86_64-cairo mingw-w64-x86_64-glib2"
          } else {
            Write-Host "安装 x86 GTK3 完整开发包..."
            & "$msysPath\usr\bin\bash.exe" -lc "pacman -S --noconfirm mingw-w64-i686-gtk3 mingw-w64-i686-harfbuzz mingw-w64-i686-pango mingw-w64-i686-cairo mingw-w64-i686-glib2"
          }

      - name: Create Build Directory
        run: New-Item -ItemType Directory -Force -Path ./build/${{ matrix.arch }}/${{ matrix.config }}/

      - name: Build sfd_tool (${{ matrix.arch }} - ${{ matrix.config }})
        run: |
          $platform = if ("${{ matrix.arch }}" -eq "x64") { "x64" } else { "Win32" }
          
          Write-Host "=== 构建配置 ==="
          Write-Host "架构: ${{ matrix.arch }}"
          Write-Host "配置: ${{ matrix.config }}"
          Write-Host "平台: $platform"
          Write-Host "================"
          
          # 简单构建 - 所有配置已在 vcxproj 中
          msbuild sfd_tool.vcxproj `
            /p:Configuration=${{ matrix.config }} `
            /p:Platform=$platform `
            /p:OutDir=./build/${{ matrix.arch }}/${{ matrix.config }}/ `
            /verbosity:minimal

      - name: Verify GTK3 DLLs Exist
        run: |
          if ("${{ matrix.arch }}" -eq "x64") {
            $gtkBinPath = "C:\msys64\mingw64\bin"
          } else {
            $gtkBinPath = "C:\msys64\mingw32\bin"
          }
          
          Write-Host "检查 GTK3 DLL 路径: $gtkBinPath"
          
          if (Test-Path $gtkBinPath) {
            $dlls = Get-ChildItem -Path $gtkBinPath -Filter "*.dll" | Select-Object -First 10
            Write-Host "找到 $(@($dlls).Count) 个 DLL 文件"
            foreach ($dll in $dlls) {
              Write-Host "  - $($dll.Name)"
            }
          } else {
            Write-Error "GTK3 bin 目录不存在: $gtkBinPath"
          }

      - name: Copy ALL DLLs from GTK3 bin directory
        run: |
          $destDir = "./build/${{ matrix.arch }}/${{ matrix.config }}/"
          
          # 确定 GTK3 bin 目录
          if ("${{ matrix.arch }}" -eq "x64") {
            $gtkBinPath = "C:\msys64\mingw64\bin"
          } else {
            $gtkBinPath = "C:\msys64\mingw32\bin"
          }
          
          Write-Host "复制所有 DLL 从: $gtkBinPath"
          Write-Host "复制到: $destDir"
          
          # 检查源目录是否存在
          if (-not (Test-Path $gtkBinPath)) {
            Write-Error "GTK3 bin 目录不存在: $gtkBinPath"
            exit 1
          }
          
          # 复制所有 DLL 文件
          $dllFiles = Get-ChildItem -Path $gtkBinPath -Filter "*.dll"
          
          if ($dllFiles.Count -eq 0) {
            Write-Warning "没有找到 DLL 文件！"
            Write-Host "目录内容:"
            Get-ChildItem -Path $gtkBinPath | Select-Object -First 20
          } else {
            foreach ($dll in $dllFiles) {
              Copy-Item $dll.FullName -Destination $destDir -Force
            }
            Write-Host "已复制 $($dllFiles.Count) 个 DLL 文件"
            
            # 显示前10个复制的文件
            Write-Host "前10个 DLL 文件:"
            $dllFiles | Select-Object -First 10 Name | ForEach-Object { Write-Host "  - $($_.Name)" }
          }
          
      - name: Copy GTK Runtime Data Files
        run: |
          $destDir = "./build/${{ matrix.arch }}/${{ matrix.config }}/"
          
          # 确定 MSYS2 目录
          if ("${{ matrix.arch }}" -eq "x64") {
            $msysPrefix = "C:\msys64\mingw64"
          } else {
            $msysPrefix = "C:\msys64\mingw32"
          }
          
          Write-Host "复制 GTK 运行时数据文件..."
          
          # 1. 复制图标主题
          $iconsSrc = "$msysPrefix\share\icons"
          $iconsDest = "$destDir\share\icons"
          
          if (Test-Path $iconsSrc) {
            New-Item -ItemType Directory -Force -Path $iconsDest
            
            # 复制 hicolor 主题（必需）
            if (Test-Path "$iconsSrc\hicolor") {
              Write-Host "复制 hicolor 图标主题..."
              Copy-Item -Path "$iconsSrc\hicolor" -Destination $iconsDest -Recurse -Force
            }
            
            # 复制 Adwaita 主题（推荐）
            if (Test-Path "$iconsSrc\Adwaita") {
              Write-Host "复制 Adwaita 图标主题..."
              Copy-Item -Path "$iconsSrc\Adwaita" -Destination $iconsDest -Recurse -Force
            }
          } else {
            Write-Warning "图标主题目录不存在: $iconsSrc"
          }
          
          # 2. 复制 GSettings schemas
          $schemasSrc = "$msysPrefix\share\glib-2.0\schemas"
          $schemasDest = "$destDir\share\glib-2.0\schemas"
          
          if (Test-Path $schemasSrc) {
            Write-Host "复制 GSettings schemas..."
            New-Item -ItemType Directory -Force -Path $schemasDest
            Copy-Item -Path "$schemasSrc\*" -Destination $schemasDest -Recurse -Force
          } else {
            Write-Error "GSettings schemas 目录不存在: $schemasSrc"
          }
          
          # 3. 复制主题
          $themesSrc = "$msysPrefix\share\themes"
          $themesDest = "$destDir\share\themes"
          
          if (Test-Path $themesSrc) {
            Write-Host "复制 GTK 主题..."
            New-Item -ItemType Directory -Force -Path $themesDest
            Copy-Item -Path "$themesSrc\Default" -Destination $themesDest -Recurse -Force -ErrorAction SilentlyContinue
          }
      - name: Cleanup Build Directory (Optional)
        run: |
          $destDir = "./build/${{ matrix.arch }}/${{ matrix.config }}/"
                
           # 删除不需要的大文件（可选）
          $unwantedExtensions = @(
            ".exe",    # 可执行文件（除了我们的）
            ".a",      # 静态库
            ".la",     # libtool 文件
            ".def",    # 导出定义
            ".sh",     # shell 脚本
            ".py",     # python 脚本
            ".pl"      # perl 脚本
           )
                
          # 保留我们的可执行文件
          $keepFiles = @("sfd_tool.exe", "sfd_tool.pdb")
                
          foreach ($ext in $unwantedExtensions) {
            Get-ChildItem -Path $destDir -Filter "*$ext" -Exclude $keepFiles | Remove-Item -Force -ErrorAction SilentlyContinue
          }
                
          Write-Host "清理后文件统计:"
          $totalFiles = (Get-ChildItem -Path $destDir).Count
          $totalSize = (Get-ChildItem -Path $destDir | Measure-Object -Property Length -Sum).Sum / 1MB
          Write-Host "  文件数量: $totalFiles"
          Write-Host "  总大小: $([math]::Round($totalSize, 2)) MB"


      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sfd_tool_${{ matrix.arch }}_${{ matrix.config }}
          path: ./build/${{ matrix.arch }}/${{ matrix.config }}/

  release:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: build
    steps:
      - name: Set Release Timestamp
        run: echo "RELEASE_TAG=sfd_tool_master_$(TZ='Asia/Shanghai' date +'%Y%m%d_%H%M')" >> $GITHUB_ENV

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: master

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: output
          pattern: sfd_tool_*_Release

      - name: Misc
        run: |
          cp master/*.md output/
          cp master/Lib/Channel9.dll output/sfd_tool_x86_Release/
          cp master/Lib/Channel.ini output/sfd_tool_x86_Release/
          cp master/Lib/libusb-1.0.dll output/sfd_tool_x64_Release/
          cd output
          mv sfd_tool_x86_Release sfd_tool_SPRD_Release
          mv sfd_tool_x64_Release sfd_tool_LibUSB_Release
          zip -r -v ../${{ env.RELEASE_TAG }}.zip .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          target_commitish: ${{ github.sha }}
          name: ${{ env.RELEASE_TAG }}
          draft: false
          prerelease: false
          body: |
            ## sfd_tool Release
            
            ### 版本说明:
            - **sfd_tool_SPRD_Release**: x86 版本，使用 SPRD 驱动
            - **sfd_tool_LibUSB_Release**: x64 版本，使用 libusb 驱动
            
            ### 使用说明:
            1. x86 版本需要安装 SPRD 驱动
            2. x64 版本需要 libusb 驱动
            3. 两个版本都是 GTK3 GUI 应用程序
            
            ### 文件列表:
            - sfd_tool.exe - 主程序
            - *.dll - 运行时依赖库
            - *.ini - 配置文件
            - README.md - 说明文档
          files: |
            ${{ env.RELEASE_TAG }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}