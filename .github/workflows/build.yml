name: Build sfd_tool

on:
  workflow_dispatch:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build:
    runs-on: windows-latest
    timeout-minutes: 30
    strategy:
      matrix:
        arch: [x64, x86]
        config: [Release]
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup MSVS
        uses: TheMrMilchmann/setup-msvc-dev@v3
        with:
          arch: ${{ matrix.arch }}

      - name: Install MSYS2 and GTK3
        run: |
          # 安装 MSYS2
          choco install -y msys2
          refreshenv
          
          # 等待安装完成
          Start-Sleep -Seconds 5
          
          # 设置 MSYS2 路径
          $msysPath = "C:\tools\msys64"
          $mingwPath = "$msysPath\mingw64"
          
          # 使用 MSYS2 bash 安装 GTK3
          $bashPath = "$msysPath\usr\bin\bash.exe"
          
          Write-Host "Updating MSYS2 package database..."
          & $bashPath -lc "pacman -Syu --noconfirm"
          
          Write-Host "Installing GTK3 development packages..."
          & $bashPath -lc "pacman -S --noconfirm mingw-w64-x86_64-gtk3 mingw-w64-x86_64-pkg-config"
          
          Write-Host "Verifying pkg-config installation..."
          # 在 bash 环境中验证
          & $bashPath -lc "which pkg-config && pkg-config --version"
          
          Write-Host "Verifying GTK3 installation..."
          & $bashPath -lc "pkg-config --modversion gtk+-3.0"
          
          # 找到 pkg-config 的实际路径
          $pkgConfigPath = & $bashPath -lc "cygpath -w `$(which pkg-config)"
          Write-Host "pkg-config path: $pkgConfigPath"
          
          # 将 MinGW bin 目录添加到系统 PATH
          $mingwBinPath = "$mingwPath\bin"
          echo "MinGW bin path: $mingwBinPath"
          echo "$mingwBinPath" | Out-File -FilePath $env:GITHUB_PATH -Append
          
          # 设置其他环境变量
          echo "GTK3_PATH=$mingwPath" | Out-File -FilePath $env:GITHUB_ENV -Append
          echo "PKG_CONFIG_PATH=$mingwPath\lib\pkgconfig" | Out-File -FilePath $env:GITHUB_ENV -Append

      - name: Verify Windows PATH
        run: |
          Write-Host "Current PATH:"
          $env:PATH -split ';' | Where-Object { $_ -like "*msys*" -or $_ -like "*mingw*" } | ForEach-Object { Write-Host "  $_" }
          
          # 直接测试 pkg-config
          Write-Host "Testing pkg-config directly..."
          $pkgConfig = "C:\tools\msys64\mingw64\bin\pkg-config.exe"
          if (Test-Path $pkgConfig) {
            & $pkgConfig --version
            & $pkgConfig --modversion gtk+-3.0
            & $pkgConfig --cflags gtk+-3.0
          } else {
            Write-Error "pkg-config not found at: $pkgConfig"
          }

      - name: Create Build Directory
        run: New-Item -ItemType Directory -Force -Path ./build/${{ matrix.arch }}/${{ matrix.config }}/

      - name: Build sfd_tool (${{ matrix.arch }} - ${{ matrix.config }})
        run: |
          # 设置平台变量
          $platform = if ("${{ matrix.arch }}" -eq "x64") { "x64" } else { "Win32" }
          
          # 直接使用 pkg-config.exe 的完整路径
          $pkgConfig = "C:\tools\msys64\mingw64\bin\pkg-config.exe"
          
          # 获取 GTK3 编译标志
          $gtkCflags = & $pkgConfig --cflags gtk+-3.0
          $gtkLibs = & $pkgConfig --libs gtk+-3.0
          
          Write-Host "GTK CFLAGS: $gtkCflags"
          Write-Host "GTK LIBS: $gtkLibs"
          
          # 构建项目
          msbuild sfd_tool.vcxproj `
            /p:Configuration=${{ matrix.config }} `
            /p:Platform=$platform `
            /p:OutDir=./build/${{ matrix.arch }}/${{ matrix.config }}/ `
            /verbosity:minimal `
            /p:AdditionalIncludeDirectories="$gtkCflags" `
            /p:AdditionalDependencies="$gtkLibs"

      - name: Copy GTK3 Runtime DLLs
        run: |
          $sourceDir = "C:\tools\msys64\mingw64\bin"
          $destDir = "./build/${{ matrix.arch }}/${{ matrix.config }}/"
          
          Write-Host "Copying DLLs from: $sourceDir"
          Write-Host "To: $destDir"
          
          # 查找并复制所有 GTK 相关的 DLL
          $gtkDlls = Get-ChildItem -Path $sourceDir -Filter "*gtk*" | ForEach-Object { $_.Name }
          $glibDlls = Get-ChildItem -Path $sourceDir -Filter "*glib*" | ForEach-Object { $_.Name }
          $gdkDlls = Get-ChildItem -Path $sourceDir -Filter "*gdk*" | ForEach-Object { $_.Name }
          
          $allDlls = $gtkDlls + $glibDlls + $gdkDlls | Select-Object -Unique
          
          foreach ($dll in $allDlls) {
            Copy-Item "$sourceDir\$dll" -Destination $destDir -Force -ErrorAction SilentlyContinue
          }
          
          Write-Host "Copied $(($allDlls | Measure-Object).Count) DLL files"

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sfd_tool_${{ matrix.arch }}_${{ matrix.config }}
          path: ./build/${{ matrix.arch }}/${{ matrix.config }}/

  release:
    if: github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    needs: build
    steps:
      - name: Set Release Timestamp
        run: echo "RELEASE_TAG=sfd_tool_master_$(TZ='Asia/Shanghai' date +'%Y%m%d_%H%M')" >> $GITHUB_ENV

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: master

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: output
          pattern: sfd_tool_*_Release

      - name: Misc
        run: |
          cp master/*.md output/
          cp master/Lib/Channel9.dll output/sfd_tool_x86_Release/
          cp master/Lib/Channel.ini output/sfd_tool_x86_Release/
          cp master/Lib/libusb-1.0.dll output/sfd_tool_x64_Release/
          cd output
          mv sfd_tool_x86_Release sfd_tool_SPRD_Release
          mv sfd_tool_x64_Release sfd_tool_LibUSB_Release
          zip -r -v ../${{ env.RELEASE_TAG }}.zip .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          target_commitish: ${{ github.sha }}
          name: ${{ env.RELEASE_TAG }}
          draft: false
          prerelease: false
          body: |
            x86 ver work with SPRD driver, x64 ver work with libusb driver
            GTK3-based GUI application
          files: |
            ${{ env.RELEASE_TAG }}.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}